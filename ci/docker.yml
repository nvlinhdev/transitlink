build-and-push-image:
  stage: docker-publish
  <<: *docker_template
  <<: *rules_main_dev_success
  needs:
    - job: "unit-tests"
      artifacts: false
    - job: "integration-tests"
      artifacts: false
  script:
    - set -e
    - docker buildx build --platform linux/amd64 -t $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA .
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
    - |
      if [[ "$CI_COMMIT_REF_NAME" == "dev" || "$CI_COMMIT_REF_NAME" == "main" ]]; then
        docker tag $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA $DOCKER_IMAGE:$CI_COMMIT_REF_NAME
        docker push $DOCKER_IMAGE:$CI_COMMIT_REF_NAME
      fi
    - docker push $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA