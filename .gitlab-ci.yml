variables:
  DOCKER_IMAGE: registry.gitlab.com/sep490_g80/transit-link-backend
  USER: transitlink
  PROJECT_DIR: "/srv/transitlink"
  BACKUPS_DIR: "/backups"
  GRADLE_VERSION: "8.14.3-jdk21-alpine"
  DOCKER_VERSION: "28.3.3"
  ALPINE_VERSION: "3.22.1"
  CURL_VERSION: "8.15.0"
  APP_DB_CONTAINER: "transitlink-db"
  APP_DB_NAME: "transitlink"
  APP_CONTAINER: "transitlink"
  KEYCLOAK_DB_CONTAINER: "keycloak-db"
  KEYCLOAK_DB_NAME: "keycloak"
  KEYCLOAK_CONTAINER: "keycloak"
  POSTGRES_IMAGE: bitnami/postgresql:17.5.0-debian-12-r20
  KEYCLOAK_IMAGE: bitnami/keycloak:26.3.1-debian-12-r2
  REDIS_IMAGE: bitnami/redis:8.0.3-debian-12-r2

# Define stages
stages:
  - test
  - merge
  - docker-publish
  - backup
  - deploy
  - cleanup

#define rules
.rules_changes: &changes
  changes:
    - "**/*.java"
    - "build.gradle.kts"
    - "setting.gradle.kts"
    - "src/**/*"

.exclude_schedule: &exclude_schedule
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never

.rules_feat_fix_hotfix_main_dev: &rules_feat_fix_hotfix_main_dev
  rules:
    - *exclude_schedule
    - if: '$CI_COMMIT_BRANCH =~ /^(feat|fix|hotfix)\/.+/'
      <<: *changes
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "dev"'
      <<: *changes
      when: on_success
    - when: never

.rules_feat_fix_hotfix: &rules_feat_fix_hotfix
  rules:
    - *exclude_schedule
    - if: '$CI_COMMIT_BRANCH =~ /^(feat|fix|hotfix)\/.+/'
      <<: *changes
      when: on_success
    - when: never

.rules_feat_fix: &rules_feat_fix
    rules:
    - *exclude_schedule
    - if: '$CI_COMMIT_BRANCH =~ /^(feat|fix)\/.+/'
      <<: *changes
      when: on_success
    - when: never

.rules_hotfix: &rules_hotfix
  rules:
    - *exclude_schedule
    - if: '$CI_COMMIT_BRANCH =~ /^hotfix\/.+/'
      <<: *changes
      when: on_success
    - when: never

.rules_main_dev: &rules_main_dev
  rules:
    - *exclude_schedule
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "dev"'
      <<: *changes
      when: always
    - when: never

.rules_main_only: &rules_main_only
  rules:
    - *exclude_schedule
    - if: '$CI_COMMIT_BRANCH == "main"'
      <<: *changes
      when: on_success
    - when: never

.rules_dev_only: &rules_dev_only
  rules:
    - *exclude_schedule
    - if: '$CI_COMMIT_BRANCH == "dev"'
      <<: *changes
      when: on_success
    - when: never

.rules_schedule_only: &rules_schedule_only
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
    - when: never

# define templates
.ssh_commands: &ssh_commands
  - apk add --no-cache openssh
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
  - chmod 600 ~/.ssh/id_rsa
  - ssh-keyscan -H $HOST >> ~/.ssh/known_hosts
  - chmod 644 ~/.ssh/known_hosts

.ssh_setup: &ssh_setup
  before_script:
    - *ssh_commands

.test_artifacts: &test_artifacts
  artifacts:
    when: always
    expire_in: 1 week
    reports:
      junit:
        - build/test-results/*/TEST-*.xml

.docker_config: &docker_config
  services:
    - name: docker:${DOCKER_VERSION}-dind
      alias: docker
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2

.backup_config: &backup_config
  stage: backup
  image: alpine:${ALPINE_VERSION}
  <<: *rules_main_only
  needs:
    - job: build-and-push-image
      artifacts: false
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  <<: *ssh_setup

# Define jobs
unit-tests:
  stage: test
  image: gradle:${GRADLE_VERSION}
  <<: *rules_feat_fix_hotfix_main_dev
  script:
    - gradle clean unitTest --no-daemon --stacktrace --info
  <<: *test_artifacts
  artifacts:
    paths:
      - build/jacoco/unitTest.exec
      - build/test-results/unitTest/
      - build/reports/tests/unitTest

integration-tests:
  stage: test
  image: gradle:${GRADLE_VERSION}
  <<: *docker_config
  variables:
    TESTCONTAINERS_HOST_OVERRIDE: docker
    TESTCONTAINERS_RYUK_DISABLED: "true"
    TESTCONTAINERS_CHECKS_DISABLE: "true"
    GRADLE_OPTS: "-Xmx2g -Dorg.gradle.daemon=false"
  <<: *rules_feat_fix_hotfix_main_dev
  before_script:
    - chmod +x scripts/integration-test-setup.sh
    - ./scripts/integration-test-setup.sh
  script:
    - gradle integrationTest --no-daemon --stacktrace --info
  after_script:
    - chmod +x scripts/docker-cleanup.sh
    - ./scripts/docker-cleanup.sh
  <<: *test_artifacts
  artifacts:
    paths:
      - build/jacoco/integrationTest.exec
      - build/test-results/integrationTest/
      - build/reports/tests/integrationTest/
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

generate_report:
  stage: test
  image: gradle:${GRADLE_VERSION}
  needs:
    - job: "unit-tests"
      artifacts: true
    - job: "integration-tests"
      artifacts: true
  <<: *rules_feat_fix_hotfix_main_dev
  script:
    - gradle jacocoCombinedTestReport --no-daemon --stacktrace --info
  artifacts:
    when: always
    paths:
      - build/reports/jacoco/combined
      - build/reports/jacoco/jacocoCombinedTestReport
    expire_in: 1 week

push-report:
  stage: test
  image: gradle:${GRADLE_VERSION}
  needs:
    - job: "generate_report"
      artifacts: true
  <<: *rules_dev_only
  before_script:
    - echo "$SONAR_TOKEN"
  script:
    - gradle sonar

create_merge_dev:
  stage: merge
  image: curlimages/curl:$CURL_VERSION
  needs:
    - job: "unit-tests"
    - job: "integration-tests"
  <<: *rules_feat_fix
  before_script:
    - apk add --no-cache jq
    - chmod +x scripts/create-merge-request.sh
  script:
    - ./scripts/create-merge-request.sh "dev"
  artifacts:
    reports:
      dotenv: merge_request_dev.env
    expire_in: 1 hour

create_merge_main:
  stage: merge
  image: curlimages/curl:$CURL_VERSION
  needs:
    - job: "unit-tests"
    - job: "integration-tests"
  <<: *rules_hotfix
  before_script:
    - apk add --no-cache jq
    - chmod +x scripts/create-merge-request.sh
  script:
    - ./scripts/create-merge-request.sh "main"
  artifacts:
    reports:
      dotenv: merge_request_main.env
    expire_in: 1 hour

approve_merge_request:
  stage: merge
  image: curlimages/curl:$CURL_VERSION
  <<: *rules_feat_fix_hotfix
  needs:
    - job: "create_merge_dev"
      artifacts: true
      optional: true
    - job: "create_merge_main"
      artifacts: true
      optional: true
  before_script:
    - apk add --no-cache jq
    - chmod +x scripts/approve-merge-request.sh
  script:
    - ./scripts/approve-merge-request.sh

build-and-push-image:
  stage: docker-publish
  image: docker:${DOCKER_VERSION}
  <<: *docker_config
  <<: *rules_main_dev
  needs:
    - job: "unit-tests"
      artifacts: false
    - job: "integration-tests"
      artifacts: false
  before_script:
    - chmod +x scripts/build-and-push-image.sh
  script:
    - ./scripts/build-and-push-image.sh

backup_app_db:
  <<: *backup_config
  before_script:
    - *ssh_commands
    - chmod +x scripts/backup-database.sh
  script:
    - ./scripts/backup-database.sh "$APP_DB_CONTAINER" "$APP_DB_NAME" "$APP_DB_USER" "$APP_DB_PASS"

backup_keycloak_db:
  <<: *backup_config
  before_script:
    - *ssh_commands
    - chmod +x scripts/backup-database.sh
  script:
    - ./scripts/backup-database.sh "$KEYCLOAK_DB_CONTAINER" "$KEYCLOAK_DB_NAME" "$KEYCLOAK_DB_USER" "$KEYCLOAK_DB_PASS"

backup_transitlink_data:
  <<: *backup_config
  before_script:
    - *ssh_commands
    - chmod +x scripts/backup-transitlink-data.sh
  script:
    - ./scripts/backup-transitlink-data.sh

deploy:
  stage: deploy
  image: alpine:${ALPINE_VERSION}
  <<: *rules_main_only
  needs:
    - job: backup_app_db
      artifacts: false
    - job: backup_keycloak_db
      artifacts: false
    - job: backup_transitlink_data
      artifacts: false
  before_script:
    - *ssh_commands
    - chmod +x scripts/deploy.sh
  script:
    - ./scripts/deploy.sh

rollback:
  stage: deploy
  image: alpine:${ALPINE_VERSION}
  <<: *rules_main_only
  variables:
    ROLLBACK_TAG: ""
  before_script:
    - *ssh_commands
    - chmod +x scripts/rollback.sh
  script:
    - ./scripts/rollback.sh "$ROLLBACK_TAG"

cleanup_backups:
  stage: cleanup
  image: alpine:${ALPINE_VERSION}
  <<: *rules_schedule_only
  before_script:
    - *ssh_commands
    - chmod +x scripts/cleanup-backups.sh
  script:
    - ./scripts/cleanup-backups.sh